<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Sounds good to me.</title>
    <description>A tech and stuff blog ... but mostly tech.
</description>
    <link>http://derkobe.github.io/</link>
    <atom:link href="http://derkobe.github.io/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Wed, 16 Dec 2015 11:24:42 +0100</pubDate>
    <lastBuildDate>Wed, 16 Dec 2015 11:24:42 +0100</lastBuildDate>
    <generator>Jekyll v3.0.1</generator>
    
      <item>
        <title>Phoenix Channels in a Google Chrome Extension</title>
        <description>&lt;p&gt;Phoenix Channels are awesome! With this out of the way let’s get down to business.&lt;/p&gt;

&lt;p&gt;I switched from a combination of Ruby on Rails, and Faye on NodeJS to Elixir/Phoenix.
Phoenix’s Channels javascript is conveniently integrated right from the start in every Phoenix project. You just use it.
But I needed it in a Google Chrome Extension and I did not found a stand-alone javascript version.&lt;/p&gt;

&lt;p&gt;I dug for the original javascript and found it in &lt;code class=&quot;highlighter-rouge&quot;&gt;PROJECT_PATH/deps/phoenix/web/static/js/phoenix.js&lt;/code&gt; in the form of ECMAScript 6.
Now Phoenix handles ES6 very elegantly via Brunch, but in my Chrome Extension project I use CoffeeScript and sometimes plain Javascript.
So I took the ES6 file and converted it to Javascript. I tried different online &lt;a href=&quot;https://en.wikipedia.org/wiki/Source-to-source_compiler&quot;&gt;transpilers&lt;/a&gt; and in the end went with &lt;a href=&quot;https://babeljs.io/repl/&quot;&gt;Babel&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I wrote a publish-subscribe-client to connect to the server and handle the channels and the subscribe, publish, and unsubscribe actions:&lt;/p&gt;

&lt;pre&gt;
class PubsubClient
  constructor: (host, signedToken)-&amp;gt;
    # host is something like https://my.server.com
    # signedToken is retrieved by a previous api call from the Phoenix backend

    # Socket comes from the transpiled phoenix.js
    @socket = new Socket(@_connectionPath(host), params: {signedToken: signedToken})
    @socket.connect()
    @channels = {}
  
  subscribe: (channel, receivers, next)-&amp;gt;
    # receivers look something like this:
    # { 
    #   &#39;some:event&#39;: (msg)-&amp;gt; console.log(msg) 
    #   &#39;some:other_event&#39;: (msg)-&amp;gt; console.log(msg)
    #   ...
    # }
    @channels[channel] ||= @socket.channel(channel)
    _.each receivers, (receiver, topic)=&amp;gt;
      @channels[channel].on(topic, (data)-&amp;gt;
        console.debug &quot;message #{topic} received on #{channel}&quot;
        receiver(data)
      )
  
    @channels[channel]
    .join()
    .receive(&#39;error&#39;, (resp)-&amp;gt;
      console.error &quot;An error occured on joining &#39;#{channel}&#39;&quot;, resp
    )
    .receive(&#39;ok&#39;, -&amp;gt;
      console.debug &quot;Successfully joined #{channel}&quot;
      next?()
    )
  
  publish: (channel, topic, data = {}, next = -&amp;gt;)-&amp;gt;
    @channels[channel] ||= @socket.channel(channel, {})
    @channels[channel]
    .push(topic, data)
    .receive(&#39;ok&#39;, next)
  
  unsubscribe: (channel, next)-&amp;gt;
    if @channels[channel]?
      @channels[channel]
      .leave()
      .receive(&#39;ok&#39;, (data)=&amp;gt;
        @channels[channel] = null
        next?(data)
      )
  
  _connectionPath: (host)-&amp;gt;
    &quot;#{host.replace(&#39;http:&#39;,&#39;ws:&#39;).replace(&#39;https:&#39;,&#39;wss:&#39;)}/socket&quot;
&lt;/pre&gt;

&lt;p&gt;There is a lot of room for improvements here. For one the passed follow-up function in form of the &lt;code class=&quot;highlighter-rouge&quot;&gt;next&lt;/code&gt;-parameters should be replaced with promises.&lt;/p&gt;

&lt;p&gt;But that’s a problem for future me.&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;comments&quot;&gt;Comments&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;If you want to comment on, or talk about this post you can do this via &lt;a href=&quot;http://jack.chat&quot;&gt;&lt;img src=&quot;/assets/talk-about-jack.png&quot; width=&quot;32&quot; height=&quot;32&quot; title=&quot;Talk About Jack&quot; /&gt;&lt;/a&gt; (just &lt;a href=&quot;https://chrome.google.com/webstore/detail/talk-about-jack/mfjhkijmchogjenmblohgkifnakapbhf&quot;&gt;install the Chrome Extension&lt;/a&gt; and leave a message in the “Page” channel of this post).
And of course you’re always welcome to reach out to me via the “Domain” Channel.&lt;/em&gt;&lt;/p&gt;
</description>
        <pubDate>Wed, 16 Dec 2015 09:44:47 +0100</pubDate>
        <link>http://derkobe.github.io/2015/12/16/phoenix-channels-in-a-google-chrome-extension.html</link>
        <guid isPermaLink="true">http://derkobe.github.io/2015/12/16/phoenix-channels-in-a-google-chrome-extension.html</guid>
        
        
      </item>
    
  </channel>
</rss>
